<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Family Video Call</title>
<style>
body { margin:0; font-family: Arial; background:#f5f5f5; }
header { background:#2d89ef; color:white; text-align:center; padding:15px; font-size:24px; }
#welcome { display:flex; flex-direction:column; align-items:center; justify-content:center; height:80vh; }
input { padding:10px; font-size:16px; margin:5px; }
button { padding:10px 20px; font-size:16px; margin:5px; border:none; border-radius:8px; background:#2d89ef; color:white; cursor:pointer; }
button:hover { background:#1b5dab; }
#controls { text-align:center; margin:10px 0; display:none; }
.video-grid { display:grid; gap:10px; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); width:100%; justify-items:center; margin:10px 0; }
video { width:300px; height:200px; border-radius:8px; background:black; }
.video-label { text-align:center; font-weight:bold; margin-top:3px; }
#chatContainer { width:90%; max-width:500px; margin:10px auto; display:none; }
#chatMessages { height:200px; border:1px solid #ccc; padding:5px; overflow-y:auto; background:white; border-radius:8px; margin-bottom:5px; }
#chatInput { width:70%; padding:10px; }
#sendBtn { padding:10px 15px; }
@media (max-width:600px) { video { width:90%; height:auto; } }
</style>
</head>
<body>
<header>üë®‚Äçüë©‚Äçüëß Family Video Call</header>

<div id="welcome">
  <h2>Welcome to Family Video Call</h2>
  <p>Enter your name to join the family room:</p>
  <input type="text" id="nameInput" placeholder="Your name">
  <button id="joinBtn">Join Call</button>
</div>

<div id="controls">
  <button id="muteBtn">Mute</button>
  <button id="cameraBtn">Turn Camera Off</button>
</div>

<div id="videos" class="video-grid"></div>

<div id="chatContainer">
  <div id="chatMessages"></div>
  <input type="text" id="chatInput" placeholder="Type a message...">
  <button id="sendBtn">Send</button>
</div>

<script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
<script>
const joinBtn = document.getElementById("joinBtn");
const nameInput = document.getElementById("nameInput");
const welcomeDiv = document.getElementById("welcome");
const videosDiv = document.getElementById("videos");
const controlsDiv = document.getElementById("controls");
const muteBtn = document.getElementById("muteBtn");
const cameraBtn = document.getElementById("cameraBtn");
const chatContainer = document.getElementById("chatContainer");
const chatMessages = document.getElementById("chatMessages");
const chatInput = document.getElementById("chatInput");
const sendBtn = document.getElementById("sendBtn");

let localStream;
let peers = {};
let dataConnections = {};
let isMuted = false;
let cameraOff = false;

const ROOM_ID = "FamilyRoomNepal2025";
const peer = new Peer(undefined, { host:'peerjs.com', port:443, secure:true });

peer.on('open', id => console.log('My Peer ID:', id));

joinBtn.onclick = async () => {
  if(!nameInput.value) { alert("Enter your name"); return; }

  welcomeDiv.style.display = "none";
  videosDiv.style.display = "grid";
  controlsDiv.style.display = "block";
  chatContainer.style.display = "block";

  localStream = await navigator.mediaDevices.getUserMedia({video:true, audio:true});
  addVideo(localStream, nameInput.value, true);

  // Handle incoming calls
  peer.on('call', call => {
    call.answer(localStream);
    call.on('stream', stream => {
      if(!peers[call.peer]) addVideo(stream, call.peer, false);
      peers[call.peer] = call;
    });
  });

  // Handle incoming data connections (chat + new peer notifications)
  peer.on('connection', conn => {
    dataConnections[conn.peer] = conn;
    conn.on('data', data => {
      if(data.type === "new-peer") callPeer(data.peerId);
      if(data.type === "chat") addMessage(data.msg);
    });
  });

  // Connect to existing peers in room (broadcast your ID)
  connectToRoom();

  // Controls
  muteBtn.onclick = () => {
    isMuted = !isMuted;
    localStream.getAudioTracks()[0].enabled = !isMuted;
    muteBtn.textContent = isMuted ? "Unmute" : "Mute";
  };
  cameraBtn.onclick = () => {
    cameraOff = !cameraOff;
    localStream.getVideoTracks()[0].enabled = !cameraOff;
    cameraBtn.textContent = cameraOff ? "Turn Camera On" : "Turn Camera Off";
  };

  sendBtn.onclick = sendMessage;
  chatInput.addEventListener("keypress", e => { if(e.key==='Enter') sendMessage(); });
};

function addVideo(stream, label, isLocal=false) {
  const container = document.createElement("div");
  const video = document.createElement("video");
  video.autoplay = true;
  if(isLocal) video.muted = true;
  video.srcObject = stream;

  const vidLabel = document.createElement("div");
  vidLabel.className = "video-label";
  vidLabel.innerText = label;

  container.appendChild(video);
  container.appendChild(vidLabel);
  videosDiv.appendChild(container);
}

function connectToRoom() {
  // Discover peers using PeerJS listAllPeers
  peer.listAllPeers(peersInRoom => {
    peersInRoom.forEach(pid => {
      if(pid !== peer.id && pid !== ROOM_ID) callPeer(pid);
    });
  });
}

function callPeer(peerId) {
  if(peers[peerId]) return;
  const call = peer.call(peerId, localStream);
  call.on('stream', stream => {
    if(!peers[peerId]) addVideo(stream, peerId, false);
  });
  peers[peerId] = call;

  const conn = peer.connect(peerId);
  dataConnections[peerId] = conn;
  conn.on('open', () => { conn.send({ type:"new-peer", peerId: peer.id }); });
  conn.on('data', data => { if(data.type==="chat") addMessage(data.msg); });
}

function sendMessage() {
  const msg = nameInput.value + ": " + chatInput.value;
  addMessage(msg);
  for(let pid in dataConnections) {
    if(dataConnections[pid].open) dataConnections[pid].send({ type:"chat", msg });
  }
  chatInput.value = "";
}

function addMessage(msg) {
  const div = document.createElement("div");
  div.textContent = msg;
  chatMessages.appendChild(div);
  chatMessages.scrollTop = chatMessages.scrollHeight;
}
</script>
</body>
</html>
